import femm
import os
from PIL import Image
from moviepy.editor import ImageSequenceClip
import shutil
import time
from matplotlib import pyplot as plt
import numpy as np

femm_doc_path = os.path.join(os.getcwd(),'femm program','Geometry.FEC')

"""
Oil -> Aceite
"""

class corona_type_PD:
    def __init__(self,V_sphere=80000,V_spike=0,FEC_doc=femm_doc_path):
        self.V_sphere = V_sphere
        self.V_spike = V_spike
        self.doc = FEC_doc
        self.modify_properties = self.mod_properties(self)
        self.make_vid = self.make_video(self)
        self.make_plots = self.make_plt(self)

    class mod_properties:
        def __init__(self,outer_instance):
            self.outer = outer_instance

        def oil_conductivity(self,ox,oy=None):
            if oy is None:
                oy = ox
            femm.ci_modifymaterial('Aceite',1,ox)
            femm.ci_modifymaterial('Aceite',2,oy)

        def oil_relative_permitivity(self,ex,ey=None):
            if ey is None:
                ey = ex
            femm.ci_modifymaterial('Aceite',3,ex)
            femm.ci_modifymaterial('Aceite',4,ey)

        def steel_conductivity(self,ox,oy=None):
            if oy is None:
                oy = ox
            femm.ci_modifymaterial('Acero',1,ox)
            femm.ci_modifymaterial('Acero',2,ox)

        def aluminum_conductivity(self,ox,oy=None):
            if oy is None:
                oy = ox
            femm.ci_modifymaterial('Aluminio',1,ox)
            femm.ci_modifymaterial('Aluminio',2,ox)

        def sphere_tension(self,tension):
            femm.ci_modifyconductorprop("Bola",1,tension)

        def spike_tension(self,tension):
            femm.ci_modifyconductorprop("Punta",1,tension) 

    class make_video:
        def __init__(self,outer_instance):
            self.outer = outer_instance

        def execute_and_save(self,name,Imax=0.018,Vmax=80000):
                # femm.ci_saveas(name)
                femm.ci_analyse(3)
                femm.ci_loadsolution()
                # femm.ci_saveas(name)
                femm.co_showdensityplot(1,0,3,Imax,0)
                femm.co_zoom(2224.3,1050,2269,1154)
                self.save_adjusted_image('Current_density_images',name)
                femm.co_showdensityplot(1,0,0,Vmax,0)
                self.save_adjusted_image('Tension_distribution_images',name)

        def save_adjusted_image(self,folder,name,broad=200,narrow=450):
                bitmap_name = os.path.join(os.getcwd(),'Trash','trash.png')
                femm.co_savebitmap(bitmap_name)
                with Image.open(bitmap_name) as img:
                    cropped_im = img.crop((0,0,broad,narrow))
                    new_name= os.path.join(os.getcwd(),'Trash',folder,name+'.png')
                    cropped_im.save(new_name)
                os.remove(bitmap_name)

        def create_video_moviepy(self,image_folder, output_video_name, fps):
            # Get the list of image paths
            images = [os.path.join(image_folder, img) for img in sorted(os.listdir(image_folder)) if img.endswith(".png") or img.endswith(".jpg")]
            output_video = os.path.join(os.getcwd(),'Videos',output_video_name)
            
            # Check if images are present
            if not images:
                print("No images found in the provided folder.")
                return

            # Create a video clip from the image sequence
            clip = ImageSequenceClip(images, fps=fps)
            
            # Write the video to the output file
            clip.write_videofile(output_video, codec='libx264', fps=fps)
            print(f"Video saved as {output_video}")

        def tension_variation(self,v1=50000,v2=80000,step=1000,fps=4,erase_trash=True):
            try:
                os.makedirs(os.path.join(os.getcwd(),'Trash','Current_density_images'))
            except FileExistsError:
                pass
            except OSError:
                raise OSError('Operating System Error')
            try:
                os.makedirs(os.path.join(os.getcwd(),'Trash','Tension_distribution_images'))
            except FileExistsError:
                pass
            except OSError:
                raise OSError('Operating System Error')

            femm.openfemm()
            femm.opendocument(self.outer.doc)
            while v1<=v2:
                v1 += step
                # self.outer.modify_properties.sphere_tension(v1*1000)
                # self.outer.modify_properties.oil_conductivity(ox=1e-12, oy=1e-12) 
                self.outer.modify_properties.sphere_tension(v1)
                self.execute_and_save(str(v1),Vmax=v2)

            femm.closefemm()

            self.create_video_moviepy(os.path.join(os.getcwd(),'Trash','Current_density_images'),
                                      os.path.join(os.getcwd(),'Videos','Tension variation - current density.mp4'),fps)
            self.create_video_moviepy(os.path.join(os.getcwd(),'Trash','Tension_distribution_images'),
                                      os.path.join(os.getcwd(),'Videos','Tension variation - tension distribution.mp4'),fps)

            if erase_trash:
                try: 
                    shutil.rmtree(os.path.join(os.getcwd(),'Trash','Current_density_images'))
                except OSError:
                    pass
                try: 
                    shutil.rmtree(os.path.join(os.getcwd(),'Trash','Tension_distribution_images'))
                except OSError:
                    pass

        def conductivity_variation_oil(self,ox_1,ox_2,ox_step,oy=None,oy_step=None,fps=4,erase_trash=True):
            if oy is None:
                oy = ox_1
            if oy_step is None:
                oy_step = ox_step
            if ox_step <= 0:
                raise ValueError('Ox_step must be greater than 0')

            try:
                os.makedirs(os.path.join(os.getcwd(),'Trash','Current_density_images'))
            except FileExistsError:
                pass
            except OSError:
                raise OSError('Operating System Error')
            try:
                os.makedirs(os.path.join(os.getcwd(),'Trash','Tension_distribution_images'))
            except FileExistsError:
                pass
            except OSError:
                raise OSError('Operating System Error')
            
            femm.openfemm()
            femm.opendocument(self.outer.doc)

            while ox_1 <= ox_2:
                self.outer.modify_properties.oil_conductivity(ox_1,oy)
                self.execute_and_save(str(ox_1)+' - '+str(oy))

                ox_1 += ox_step
                oy += oy_step

            femm.closefemm()

            
            self.create_video_moviepy(os.path.join(os.getcwd(),'Trash','Current_density_images'),
                                      os.path.join(os.getcwd(),'Videos','Conductivity variation - current density.mp4'),fps)
            self.create_video_moviepy(os.path.join(os.getcwd(),'Trash','Tension_distribution_images'),
                                      os.path.join(os.getcwd(),'Videos','Conductivity variation - tension distribution.mp4'),fps)

            if erase_trash:
                try: 
                    shutil.rmtree(os.path.join(os.getcwd(),'Trash','Tension_distribution_images'))
                except OSError:
                    pass
                try: 
                    shutil.rmtree(os.path.join(os.getcwd(),'Trash','Current_density_images'))
                except OSError:
                    pass
            
    class make_plt:
        def __init__(self,outer_instance):
            self.outer = outer_instance

        def calculate_current(self,x1=2228*100,x2=2268*100,y=1120):
            q = 0
            for x in range(x1,x2,100):
                x = x/100
                Jx,Jy = femm.co_getpointvalues(x,y)[1:3]
                J = ((abs(Jx))**2+(abs(Jy))**2)**(1/2)
                q += abs(J/100)
            return q
        
        def plot_formal_line(self,x, y, title, xlabel, ylabel, legend):
            plt.figure(figsize=(8, 5))
            
            # Establecer el estilo formal
            plt.style.use('ggplot')
            
            # Fondo blanco
            plt.gcf().set_facecolor('white')
            
            # Gráfico de línea
            plt.plot(x, y, marker='o', linestyle='-', color='blue', label=legend, linewidth=2)

            # Títulos y etiquetas
            plt.title(title, fontsize=18, weight='bold')
            plt.xlabel(xlabel, fontsize=14)
            plt.ylabel(ylabel, fontsize=14)
            
            # Leyenda
            plt.legend(fontsize=12, loc='upper left')
            
            # Ejes y cuadrícula
            plt.grid(True, which='both', linestyle='--', linewidth=0.5)
            
            # Bordes de los ejes
            plt.gca().spines['top'].set_visible(False)
            plt.gca().spines['right'].set_visible(False)
            plt.gca().spines['left'].set_color('gray')
            plt.gca().spines['bottom'].set_color('gray')
            
            # Ajuste del diseño
            plt.tight_layout()
            
            # Guardar el gráfico
            plt.savefig(os.path.join(os.getcwd(),'Plots',title+' [{}-{}].png'.format(x[0],x[-1])), dpi=300)
            print('Plot saved in',os.path.join(os.getcwd(),'Plots',title+' [{}-{}].png'.format(x[0],x[-1])))
            
            # Mostrar el gráfico
            # plt.show()

        def current_density_distribution_in_axis(self,num_dots=50,y1=0,y2=49.99):
            #(0,0) = (2247.5750,1125.8-50)
            #(0,50) = (2247.5750,1125.8)

            if y2>50:
                raise ValueError("Invalid value of y2. Cannot surpass 50")

            femm.openfemm()
            femm.opendocument(self.outer.doc)
            femm.ci_analyse(3)
            femm.ci_loadsolution()

            axis_analisis = np.arange(1125.8-0.95-y2,1125.8-0.95-y1,(y2-y1+0.000001)/num_dots)
            Voltage_values,Current_density_values = [],[]
            for y in axis_analisis:
                V,Jx,Jy = femm.co_getpointvalues(2247.5750,y)[:3]
                J = (abs(Jx)**2+abs(Jy)**2)**(1/2)
                Voltage_values.append(abs(V))
                Current_density_values.append(J)

            x_axis = np.arange(y1,y2,(y2-y1+0.000001)/num_dots)
            self.plot_formal_line(x_axis,Current_density_values,'Current density through axis','Height axis','Current density [A/mm^2]',None)
            self.plot_formal_line(x_axis,Voltage_values,'Tension values through axis','Height axis','Tension [V]',None)

        def current_variation_with_properties_variation(self,propertie,value1,value2,num_dots):
            properties = ['Tension']
            if propertie not in properties:
                raise ValueError("Error, {} is not amongst the options. \nOptions: {}".format(propertie,properties))
            values = np.arange(value1,value2,(value2-value1)/num_dots)

            femm.openfemm()
            femm.opendocument(self.outer.doc)
            
            if propertie == 'Tension':
                Is = []
                for value in values:
                    self.outer.modify_properties.sphere_tension(value)
                    femm.ci_analyse(3)
                    femm.ci_loadsolution()
                    Is.append(self.calculate_current())
                self.plot_formal_line(values,Is,'Current variation caused by tension','Tension [V]','Current [A]',None)
